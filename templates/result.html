<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Application Vulnerability Scanner</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background-color: #121212;
  color: #e0e0e0;
  font-family: 'Segoe UI', sans-serif;
  margin:0; padding:0;
}
.navbar {
  background: #1f1f1f;
  padding: 1rem;
}
.container { max-width: 1200px; margin:30px auto; }
.section-title {
  text-align:center;
  font-size:1.8rem;
  font-weight:bold;
  color:#fff;
  margin-bottom:20px;
}
.glass-card {
  background: rgba(30,30,30,0.75);
  border-radius:16px;
  padding:2rem;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  margin-bottom:2rem;
  transition: transform 0.3s;
}
.glass-card:hover { transform: translateY(-3px); }
.gradient-bar {
  height: 5px;
  border-radius: 3px;
  background: linear-gradient(90deg, #ff6a00, #00ff88);
  margin: 1rem 0 2rem 0;
}
.table th, .table td { color:#fff; vertical-align:middle; }
.table-striped > tbody > tr:nth-of-type(odd) { background-color: rgba(255,255,255,0.05); }
.btn-scan, .btn-primary {
  background: linear-gradient(45deg, #ff6a00, #00c853);
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1.5rem;
  color: #fff;
  font-weight: bold;
  transition: 0.3s;
  margin: 0.5rem;
}
.btn-scan:hover, .btn-primary:hover { opacity:0.9; transform: scale(1.05); }
.chart-container { width: 300px; margin:auto; }
.summary-item { font-size:1.05rem; margin-bottom:10px; }
.status-ok { color:#2ecc71; font-weight:bold; }
.status-fail { color:#ff6b6b; font-weight:bold; }
.suggestion-box {
  margin-bottom:20px; 
  padding:15px; 
  border-left:5px solid #ff6a00; 
  background: rgba(26,26,26,0.8); 
  border-radius:10px;
  transition: 0.3s;
}
.suggestion-box:hover { background: rgba(26,26,26,0.9); }
.suggestion-box h5 { color:#ff8c42; margin-bottom:10px; }
.suggestion-box p { color:#bbb; font-size:0.95rem; }
.suggestion-box .fix { color:#9cdcfe; }

/* Hide printable area by default */
#printableArea { display: none; }

/* Print-specific styles */
@media print {
  body * { visibility: hidden; }
  #printableArea, #printableArea * { visibility: visible; display: block; }
  #printableArea { position: absolute; left: 0; top: 0; width: 100%; color:#000; background:#fff; padding: 20px; }
  #printableArea h2, #printableArea h3, #printableArea h4 { color: #000; }
  #printableArea p, #printableArea li { color: #000; font-size: 12pt; }
  #printableArea ul { padding-left: 20px; }
}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark">
  <div class="container d-flex justify-content-between">
    <a class="navbar-brand fw-bold text-white">Web Application Vulnerability Scanner</a>
    <div>
      {% if session.get('username') %}
        <span class="me-3">Hello, <strong>{{ session['username'] }}</strong></span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-sm me-2">Login</a>
        <a href="{{ url_for('register') }}" class="btn btn-outline-warning btn-sm">Register</a>
      {% endif %}
    </div>
  </div>
</nav>

<div class="container">

  <!-- Vulnerability Results -->
<section class="glass-card">
  <h2 class="section-title">Vulnerability Results & Overview</h2>
  <p>You scanned: <strong>{{ url }}</strong> | Scan Time: <strong>{{ scan_time }}</strong></p>
  <div class="gradient-bar"></div>

  <div class="row mt-3">
    <div class="col-lg-7">
      <h4>Status Table</h4>
      <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th>Vulnerability</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln, status in vulnerabilities.items() %}
          <tr>
            <td>{{ vuln }}</td>
            <td>
              {% if "No" in status or "safe" in status or "secure" in status or "protection active" in status %}
                <span class="status-ok">&#9989; {{ status }}</span>
              {% else %}
                <span class="status-fail">&#10060; {{ status }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="col-lg-5 chart-container text-center">
      <canvas id="pieChart"></canvas>
      <p style="margin-top:10px;">Detected vs Safe Vulnerabilities</p>
      <a href="{{ url_for('download_csv', job_id=job_id) }}" class="btn btn-primary">Download CSV</a>
    </div>
  </div>
</section>


  <!-- Scan Summary -->
  <section class="glass-card">
    <h2 class="section-title">Scan Summary</h2>
    {% if invalid %}
      <p style="color:#ff6b6b; font-weight:bold;">Invalid URL entered. Please use a valid domain.</p>
    {% else %}
    <div class="row text-center">
      <div class="col-md-4 summary-item">Total Vulnerabilities: <strong>{{ total_detected }}</strong></div>
      <div class="col-md-4 summary-item">Safe Checks: <strong>{{ total_safe }}</strong></div>
      <div class="col-md-4 summary-item">High-Risk: <strong>{{ high_risk_count }}</strong></div>
      <div class="col-md-4 summary-item">URL: <strong>{{ url }}</strong></div>
      <div class="col-md-4 summary-item">Duration: <strong>{{ scan_duration }}</strong></div>
      <div class="col-md-4 summary-item">Security Score: 
        <strong style="color:{% if overall_score >= 80 %}#2ecc71{% elif overall_score >=50 %}#f1c40f{% else %}#ff6b6b{% endif %}">{{ overall_score }}%</strong>
      </div>
    </div>
    {% endif %}
    <div class="gradient-bar"></div>
  </section>

  <!-- Suggested Solutions -->
  <section class="glass-card">
    <h2 class="section-title">Suggested Solutions</h2>
    {% for vuln, status in vulnerabilities.items() %}
      {% if "No" not in status and "safe" not in status %}
        <div class="suggestion-box">
          <h5>{{ vuln }}</h5>
          <p><strong>Status:</strong> {{ status }}</p>
          <p class="fix"><strong>Why this is a risk:</strong> {{ detailed_info[vuln] }}</p>
          <p class="fix"><strong>Suggested Fix:</strong><br>
            {% if vuln == "SQL Injection" %}
              • Use prepared statements (parameterized queries).<br>
              • Apply strict input validation & whitelist-based filtering.<br>
              • Use ORM frameworks.<br>
              • Restrict database account permissions.<br>
            {% elif vuln == "XSS" %}
              • Encode user inputs before rendering.<br>
              • Use DOMPurify or CSP.<br>
              • Avoid inline JS.<br>
            {% elif vuln == "Directory Traversal" %}
              • Validate file paths.<br>
              • Restrict file access.<br>
            {% elif vuln == "Open Redirect" %}
              • Sanitize redirect parameters.<br>
            {% elif vuln == "Clickjacking" %}
              • X-Frame-Options: DENY or SAMEORIGIN.<br>
            {% elif vuln == "Insecure HTTP Headers" %}
              • Add CSP, HSTS, X-Frame-Options.<br>
            {% elif vuln == "Unsafe HTTP Methods" %}
              • Disable unsafe HTTP methods.<br>
            {% elif vuln == "Robots.txt Check" %}
              • Avoid exposing sensitive directories.<br>
            {% else %}
              • Apply secure coding & patch libraries.<br>
            {% endif %}
          </p>
        </div>
      {% endif %}
    {% endfor %}
  </section>

 <!-- Actions -->
 <section class="glass-card text-center">
   <button class="btn btn-primary" onclick="printReport()">Print Result</button>
   <a href="/" class="btn btn-primary">Scan Again</a>
 </section>

</div>

<!-- Hidden print-friendly content -->
<div id="printableArea">
  <h2>Hellboy v5 - Scan Report</h2>
  <p><strong>Scanned URL:</strong> {{ url }}</p>
  <p><strong>Scan Time:</strong> {{ scan_time }}</p>
  <p><strong>Total Vulnerabilities:</strong> {{ total_detected }}</p>
  <p><strong>Safe Checks:</strong> {{ total_safe }}</p>
  <p><strong>High-Risk Vulnerabilities:</strong> {{ high_risk_count }}</p>
  <p><strong>Scan Duration:</strong> {{ scan_duration }}</p>
  <p><strong>Security Score:</strong> {{ overall_score }}%</p>

  <h3>Suggested Fixes:</h3>
  {% for vuln, status in vulnerabilities.items() %}
    {% if "No" not in status and "safe" not in status %}
      <h4>{{ vuln }}</h4>
      <p><strong>Why this is a risk:</strong> {{ detailed_info[vuln] }}</p>
      <ul>
        {% if vuln == "SQL Injection" %}
          <li>Use prepared statements (parameterized queries).</li>
          <li>Apply strict input validation & whitelist-based filtering.</li>
          <li>Use ORM frameworks.</li>
          <li>Restrict database account permissions.</li>
        {% elif vuln == "XSS" %}
          <li>Encode user inputs before rendering.</li>
          <li>Use DOMPurify or CSP.</li>
          <li>Avoid inline JS.</li>
        {% elif vuln == "Directory Traversal" %}
          <li>Validate file paths.</li>
          <li>Restrict file access.</li>
        {% elif vuln == "Open Redirect" %}
          <li>Sanitize redirect parameters.</li>
        {% elif vuln == "Clickjacking" %}
          <li>X-Frame-Options: DENY or SAMEORIGIN.</li>
        {% elif vuln == "Insecure HTTP Headers" %}
          <li>Add CSP, HSTS, X-Frame-Options.</li>
        {% elif vuln == "Unsafe HTTP Methods" %}
          <li>Disable unsafe HTTP methods.</li>
        {% elif vuln == "Robots.txt Check" %}
          <li>Avoid exposing sensitive directories.</li>
        {% else %}
          <li>Apply secure coding & patch libraries.</li>
        {% endif %}
      </ul>
    {% endif %}
  {% endfor %}
</div>

<script>
// Pie chart
const ctx = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(ctx, {
  type: 'pie',
  data: {
    labels: ['Detected', 'Safe'],
    datasets: [{
      data: [{{ total_detected }}, {{ total_safe }}],
      backgroundColor: ['#ff6b6b','#2ecc71'],
      borderColor: '#121212',
      borderWidth: 1
    }]
  },
  options: {
    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
  }
});

// Print function
function printReport() {
  window.print();
}
</script>
</body>
</html>
